<Project>
    <PropertyGroup>
        <_SdkTemplateDir>$(MSBuildThisFileDirectory)..\..\..\..\Data\SdkTemplate</_SdkTemplateDir>
        <_GeneratedDir>$(BaseIntermediateOutputPath)\stellar-workload</_GeneratedDir>
    </PropertyGroup>

    <Target Name="ValidateSdkTemplates" 
            BeforeTargets="BeforeResolveReferences">
        <Error Condition="!Exists('$(_SdkTemplateDir)')"
               Text="SdkTemplate directory not found: $(_SdkTemplateDir)"/>
    </Target>

    <Target Name="GenerateWorkloadManifest"
            BeforeTargets="BeforeResolveReferences"
            DependsOnTargets="ValidateSdkTemplates">
        <MakeDir Directories="$(_GeneratedDir)"/>

        <PropertyGroup>
            <_ManifestTemplate>
                $([System.IO.File]::ReadAllText('$(_SdkTemplateDir)\WorkloadManifest.template.json'))
            </_ManifestTemplate>

            <_GeneratedManifest>
                $(_ManifestTemplate.Replace('{StellarSdkVersion}', '$(StellarSdkVersion)'))
            </_GeneratedManifest>
        </PropertyGroup>

        <WriteLinesToFile
                File="$(_GeneratedDir)\WorkloadManifest.json"
                Lines="$(_GeneratedManifest)"
                Overwrite="true"/>
    </Target>

    <Target Name="PackWorkloadArtifacts" 
            BeforeTargets="BeforeResolveReferences" 
            DependsOnTargets="GenerateWorkloadManifest">
        <ItemGroup>
            <Content Include="$(_GeneratedDir)\WorkloadManifest.json">
                <Pack>true</Pack>
                <PackagePath>data/workload/</PackagePath>
            </Content>
            
            <Content Include="$(_SdkTemplateDir)\WorkloadManifest.targets">
                <Pack>true</Pack>
                <PackagePath>data/workload/</PackagePath>
            </Content>
        </ItemGroup>
    </Target>
</Project>
