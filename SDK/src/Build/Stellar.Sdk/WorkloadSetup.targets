<Project>
    <PropertyGroup>
        <_SdkTemplateDir>$(MSBuildThisFileDirectory)..\..\..\..\Data\Template\SDK</_SdkTemplateDir>
        <_GeneratedDir>$(MSBuildThisFileDirectory)..\..\..\..\Data\.generated</_GeneratedDir>
    </PropertyGroup>

    <Target Name="ValidateSdkTemplates"
            BeforeTargets="BeforeResolveReferences">
        <Error Condition="!Exists('$(_SdkTemplateDir)')"
               Text="SdkTemplate directory not found: $(_SdkTemplateDir)"/>
    </Target>

    <Target Name="GenerateWorkloadManifest"
            BeforeTargets="BeforeResolveReferences"
            DependsOnTargets="ValidateSdkTemplates">
        <MakeDir Directories="$(_GeneratedDir)\stellar-workload"/>

        <PropertyGroup>
            <_ManifestTemplate>
                $([System.IO.File]::ReadAllText('$(_SdkTemplateDir)\WorkloadManifest.template.json'))
            </_ManifestTemplate>

            <_GeneratedManifest>
                $(_ManifestTemplate.Replace('{StellarSdkVersion}', '$(StellarSdkVersion)'))
            </_GeneratedManifest>
        </PropertyGroup>

        <WriteLinesToFile
                File="$(_GeneratedDir)\stellar-workload\WorkloadManifest.json"
                Lines="$(_GeneratedManifest)"
                Overwrite="true"/>
        
        <Copy SourceFiles="$(_SdkTemplateDir)\WorkloadManifest.targets"
              DestinationFiles="$(_GeneratedDir)\stellar-workload\WorkloadManifest.targets"/>
    </Target>

    <Target Name="GenerateSharedDescriptor"
            BeforeTargets="BeforeResolveReferences"
            DependsOnTargets="ValidateSdkTemplates">
        <MakeDir Directories="$(_GeneratedDir)"/>

        <WriteLinesToFile
                File="$(_GeneratedDir)\.stellar.desc.json"
                Lines="{
    &quot;SdkVersion&quot;: &quot;$(StellarSdkVersion)&quot;,
    &quot;ToolsVersion&quot;: &quot;$(StellarToolsVersion)&quot;,
    &quot;KernelVersion&quot;: &quot;$(StellarKernelVersion)&quot;,
    &quot;EngineVersion&quot;: &quot;$(StellarEngineVersion)&quot;
}"
                Overwrite="true"/>
    </Target>
</Project>
