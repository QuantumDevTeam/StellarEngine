<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <Import Project="Sdk.targets" Sdk="Microsoft.NET.Sdk"/>

    <Target Name="ValidatingPropertyes" BeforeTargets="BeforeResolveReferences">
        <Error Condition="'$(StellarSdkUsage)' == ''">StellarSdkUsage must be configured</Error>
        <Error Condition="!Exists('$(StellarProjectConfigurationFile)')">$(StellarProjectConfigurationFile) config is not find in project files</Error>
        <Error Condition="'$(StellarEnginePath)' == ''">STELLAR_ENGINE_PATH environment variable is not set.</Error>
        <Error Condition="'$(StellarEngineVersion)' == ''">Stellar Engine must be configured</Error>
    </Target>

    <UsingTask TaskName="Stellar.Sdk.Tasks.StellarConfigParser"
               AssemblyFile="$(MSBuildThisFileDirectory)..\lib\win-x64\Stellar.Sdk.Tasks.dll"/>
    <Target Name="StellarParseConfigurations" BeforeTargets="BeforeResolveReferences" DependsOnTargets="ValidatingPropertyes">
        <Message Importance="high" Text="=== STELLAR SDK: Configuration parsing ==="/>

        <StellarConfigParser
                ProjectDirectory="$(MSBuildProjectDirectory)"
                StellarProjectName="$(StellarProjectName)"
                StellarProjectConfigurationFile="$(StellarProjectConfigurationFile)"
                StellarLocalizationIndexType="$(StellarLocalizationIndexType)">
            <Output TaskParameter="Assets" ItemName="StellarAssets"/>
            <Output TaskParameter="EmbeddedAssets" ItemName="StellarEmbeddedAssets"/>

            <Output TaskParameter="StellarCultureIndexFilesList" ItemName="StellarCultureIndexFilesList"/>
            <Output TaskParameter="SupportedCultures" ItemName="StellarSupportedCultures"/>
            <Output TaskParameter="DefaultCulture" ItemName="StellarDefaultCulture"/>
        </StellarConfigParser>

        <ItemGroup>
            <!-- Assets -->
            <Content Include="@(StellarAssets)"/>
            <EmbeddedResource Include="@(StellarEmbeddedAssets)"/>

            <!-- Localization -->
            <Content Include="@(StellarCultureIndexFilesList)"
                     Condition="'$(StellarLocalizationIndexType)' == 'External'"/>
            <EmbeddedResource Include="@(StellarCultureIndexFilesList)"
                              Condition="'$(StellarLocalizationIndexType)' == 'Embedded'"/>
        </ItemGroup>
    </Target>

    <UsingTask TaskName="Stellar.Sdk.Tasks.StellarEntryPointFind"
               AssemblyFile="$(MSBuildThisFileDirectory)..\lib\win-x64\Stellar.Sdk.Tasks.dll"/>
    <Target Name="StellarFindEntryPoint" BeforeTargets="CoreCompile">
        <Message Importance="high" Text="=== STELLAR SDK: Searching entry point ==="/>

        <StellarEntryPointFind
                CompileItems="@(Compile)"
                ProjectDirectory="$(MSBuildProjectDirectory)">
            <Output TaskParameter="StellarEntryPoint" ItemName="StellarEntryPoint"/>
        </StellarEntryPointFind>
    </Target>

    <UsingTask TaskName="Stellar.Sdk.Tasks.StellarConfigGenerator"
               AssemblyFile="$(MSBuildThisFileDirectory)..\lib\win-x64\Stellar.Sdk.Tasks.dll"/>
    <Target Name="StellarGenerateRunrimeConfig"
            BeforeTargets="Build"
            DependsOnTargets="StellarParseConfigurations;StellarFindEntryPoint;ValidatingPropertyes">
        <Message Importance="high" Text="=== STELLAR SDK: Configuration files generating ==="/>

        <StellarConfigGenerator
                IntermediateOutputPath="$(IntermediateOutputPath)"
                StellarSdkUsage="$(StellarSdkUsage)"

                StellarProjectName="$(StellarProjectName)"
                CompanyName="$(Company)"

                Version="$(Version)"
                StellarSdkVersion="$(StellarSdkVersion)"
                StellarEngineVersion="$(StellarEngineVersion)"

                StellarEntryPoint="@(StellarEntryPoint)"

                StellarAssets="@(StellarAssets)"
                StellarEmbeddedAssets="@(StellarEmbeddedAssets)"

                StellarDefaultCulture="@(StellarDefaultCulture)"
                StellarSupportedCultures="@(StellarSupportedCultures)"
                StellarCultureIndexFilesList="@(StellarCultureIndexFilesList)"

                StellarLocalizationIndexType="$(StellarLocalizationIndexType)"
                StellarRuntimeConfigType="$(StellarRuntimeConfigType)">
            <Output TaskParameter="StellarRuntimeConfigFile" ItemName="StellarRuntimeConfigFile"/>
        </StellarConfigGenerator>

        <ItemGroup>
            <Content Include="@(StellarRuntimeConfigFile)"
                     Condition="'$(StellarRuntimeConfigType)' == 'External'"/>
            <EmbeddedResource Include="@(StellarRuntimeConfigFile)"
                              Condition="'$(StellarRuntimeConfigType)' == 'Embedded'"/>
        </ItemGroup>
    </Target>

    <!--    <UsingTask TaskName="Stellar.Sdk.Tasks.StellarExecutableGenerator"-->
    <!--               AssemblyFile="$(MSBuildThisFileDirectory)..\lib\win-x64\Stellar.Sdk.Tasks.dll"/>-->
    <!--    <Target Name="StelalrGenerateExecutable" AfterTargets="Build"-->
    <!--            Condition="'$(StellarSdkUsage)' == 'Game'" DependsOnTargets="ValidatingPropertyes">-->
    <!--        <StellarExecutableGenerator-->
    <!--                StellarProjectName="$(StellarProjectName)"-->
    <!--                StellarOutputType="$(StellarOutputType)"-->
    <!--                StellarEnginePath="$(StellarEnginePath)"-->
    <!--                OutputPath="$(OutputPath)"-->
    <!--                RunConfiguration="$(Configuration)"/>-->
    <!--    </Target>-->
</Project>