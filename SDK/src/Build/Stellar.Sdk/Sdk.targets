<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <Import Project="Sdk.targets" Sdk="Microsoft.NET.Sdk"/>

    <PropertyGroup>
        <_TasksBynaryFile>..\lib\netstandard2.0\Stellar.Sdk.Tasks.dll</_TasksBynaryFile>
    </PropertyGroup>

    <!-- Validating -->

    <Target Name="StellarValidating"
            BeforeTargets="BeforeResolveReferences">
        <Message IsCritical="true"
                 Condition="'$(StellarSdkUsage)' == ''"
                 Importance="high"
                 Text="StellarSdkUsage must be configured!"/>

        <Message IsCritical="true"
                 Condition="!Exists('$(StellarProjectConfigurationFile)')"
                 Importance="high"
                 Text="Config is not find in project files. Path: $(StellarProjectConfigurationFile)"/>

        <Message IsCritical="true"
                 Condition="!Exists('$(_TasksBynaryFile)')"
                 Importance="high"
                 Text="Stellar.Sdk has no targets DLL. Path: (_TasksBynaryFile)"/>
    </Target>

    <!-- Config -->

    <UsingTask TaskName="Stellar.Sdk.Tasks.StellarConfigParser"
               AssemblyFile="$(_TasksBynaryFile)"
               Condition="Exists('$(_TasksBynaryFile)')"/>
    <Target Name="StellarParseConfigurations"
            BeforeTargets="BeforeResolveReferences"
            DependsOnTargets="StellarValidating">
        <Message Importance="high" Text="=== STELLAR SDK: Configuration parsing ==="/>

        <StellarConfigParser
                ProjectDirectory="$(MSBuildProjectDirectory)"
                StellarProjectName="$(StellarProjectName)"
                StellarProjectConfigurationFile="$(StellarProjectConfigurationFile)"
                StellarLocalizationIndexType="$(StellarLocalizationIndexType)">
            <Output TaskParameter="Assets" ItemName="StellarAssets"/>
            <Output TaskParameter="EmbeddedAssets" ItemName="StellarEmbeddedAssets"/>

            <Output TaskParameter="DefaultCulture" ItemName="StellarDefaultCulture"/>
            <Output TaskParameter="SupportedCultures" ItemName="StellarSupportedCultures"/>

            <Output TaskParameter="StellarCultureIndexFilesList" ItemName="StellarCultureIndexFilesList"/>
        </StellarConfigParser>

        <ItemGroup>
            <!-- Assets -->
            <Content Include="@(StellarAssets)"/>
            <EmbeddedResource Include="@(StellarEmbeddedAssets)"/>

            <!-- Localization -->
            <Content Include="@(StellarCultureIndexFilesList)"
                     Condition="'$(StellarLocalizationIndexType)' == 'External'"/>
            <EmbeddedResource Include="@(StellarCultureIndexFilesList)"
                              Condition="'$(StellarLocalizationIndexType)' == 'Embedded'"/>
        </ItemGroup>
    </Target>

    <UsingTask TaskName="Stellar.Sdk.Tasks.StellarEntryPointFind"
               AssemblyFile="$(_TasksBynaryFile)"
               Condition="Exists('$(_TasksBynaryFile)')"/>
    <Target Name="StellarFindEntryPoint"
            BeforeTargets="CoreCompile">
        <Message Importance="high" Text="=== STELLAR SDK: Searching entry point ==="/>

        <StellarEntryPointFind
                CompileItems="@(Compile)"
                ProjectDirectory="$(MSBuildProjectDirectory)"
                StellarProjectName="$(StellarProjectName)">
            <Output TaskParameter="StellarEntryPoint" ItemName="StellarEntryPoint"/>
        </StellarEntryPointFind>
    </Target>

    <UsingTask TaskName="Stellar.Sdk.Tasks.StellarConfigGenerator"
               AssemblyFile="$(_TasksBynaryFile)"
               Condition="Exists('$(_TasksBynaryFile)')"/>
    <Target Name="StellarGenerateRunrimeConfig"
            BeforeTargets="Build"
            DependsOnTargets="StellarParseConfigurations;StellarFindEntryPoint">
        <Message Importance="high" Text="=== STELLAR SDK: Configuration files generating ==="/>

        <StellarConfigGenerator
                IntermediateOutputPath="$(IntermediateOutputPath)"
                StellarSdkUsage="$(StellarSdkUsage)"
                StellarRuntimeConfigType="$(StellarRuntimeConfigType)"

                Version="$(Version)"
                StellarSdkVersion="$(StellarSdkVersion)"
                StellarEngineVersion="$(StellarEngineVersion)"

                StellarProjectName="$(StellarProjectName)"
                StellarEntryPoint="@(StellarEntryPoint)"

                StellarAssets="@(StellarAssets)"
                StellarEmbeddedAssets="@(StellarEmbeddedAssets)"

                StellarDefaultCulture="@(StellarDefaultCulture)"
                StellarSupportedCultures="@(StellarSupportedCultures)"

                StellarLocalizationIndexType="$(StellarLocalizationIndexType)"
                StellarCultureIndexFilesList="@(StellarCultureIndexFilesList)">
            <Output TaskParameter="StellarRuntimeConfigFile" ItemName="StellarRuntimeConfigFile"/>
        </StellarConfigGenerator>

        <ItemGroup>
            <Content Include="@(StellarRuntimeConfigFile)"
                     Condition="'$(StellarRuntimeConfigType)' == 'External'"/>
            <EmbeddedResource Include="@(StellarRuntimeConfigFile)"
                              Condition="'$(StellarRuntimeConfigType)' == 'Embedded'"/>
        </ItemGroup>
    </Target>

    <!-- Building -->
    <Target Name="StellarGenerateAssemblyInfoAttributes"
            BeforeTargets="CoreCompile">
        <Message Importance="high" Text="=== STELLAR SDK: AssemblyInfo generation ==="/>

        <WriteLinesToFile
                File="$(IntermediateOutputPath)Stellar.AssemblyInfo.g.cs"
                Lines="//------------------------------------------------------------------------------
// This code automatically generated by Stellar.Tools build
//------------------------------------------------------------------------------

using System.Reflection%3B
[assembly: AssemblyMetadata(&quot;StellarOrchesterVersion&quot;, &quot;$(StellarOrchesterVersion)&quot;)]
[assembly: AssemblyMetadata(&quot;StellarRuntimeConfigType&quot;, &quot;$(StellarRuntimeConfigType)&quot;)]
"
                Overwrite="true"/>

        <ItemGroup>
            <Compile Include="$(IntermediateOutputPath)Stellar.AssemblyInfo.g.cs"/>
        </ItemGroup>
    </Target>

    <UsingTask TaskName="Stellar.Sdk.Tasks.StellarExecutableGenerator"
               AssemblyFile="$(_TasksBynaryFile)"
               Condition="Exists('$(_TasksBynaryFile)')"/>
    <Target Name="StellarGenerateExecutable"
            AfterTargets="Build"
            DependsOnTargets="StellarFindEntryPoint"
            Condition="'$(StellarSdkUsage)' == 'Game'">
        <Message Importance="high" Text="=== STELLAR SDK: Executable generation for Game ==="/>

        <StellarExecutableGenerator
                ProjectDirectory="$(MSBuildProjectDirectory)"
                OutputPath="$(OutputPath)"
                RunConfiguration="$(Configuration)"

                StellarProjectName="$(StellarProjectName)"
                StellarOutputType="$(StellarOutputType)"
                StellarOrchesterIntallationDir="$(StellarOrchesterIntallationDir)"/>
    </Target>
</Project>